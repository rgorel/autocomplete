var db = require('./db');
var Loader = require('./loader');
var config = {
  url: '/',
  limit: 5,
  onUpdateStart: function() {},
  onUpdate: function() {}
};


function init(userConfig) {
  Object.keys(userConfig).forEach(function(key) {
    config[key] = userConfig[key];
  });

  return db.load()
    .then(function() {
      if (db.isEmpty()) return update();
    });
}

function update() {
  var loader = new Loader(config.url);
  config.onUpdateStart();
  db.truncate();

  return loader.load(db.index)
    .then(db.save)
    .then(config.onUpdate);
}

module.exports = {
  init: init,
  update: update,
  search: function(term) {
    return db.search(term, config.limit);
  },
  getLastUpdated: db.getUpdatedAt
};