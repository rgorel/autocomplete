var Promise = require('promise');

function Loader(url) {
  this.load = function(cb) {
    return new Promise(function(fulfill, reject) {
      var xhr = new XMLHttpRequest();
      var lastPos = 0;

      xhr.addEventListener('progress', function() {
        if (xhr.readyState < 3) return;

        var lastBreakPos = xhr.readyState > 3 ? xhr.responseText.length : xhr.responseText.lastIndexOf("\n");
        var data = xhr.responseText.substring(lastPos, lastBreakPos);

        data.split("\n").forEach(function(word) {
          cb(word);
        });

        lastPos = lastBreakPos;
      });

      xhr.addEventListener('load', fulfill);
      xhr.addEventListener('error', reject);

      xhr.open('GET', url);
      xhr.send();
    });
  };
}

module.exports = Loader;